承知いたしました。
要件定義書に「スレッド機能」が追加されたことを考慮し、開発ロードマップとプロンプト一覧を全面的に再構築します。

スレッド機能はチャットアプリケーションの中核機能の一つであり、データベース設計、API、リアルタイム通信、UIの各側面に影響を与えます。これを踏まえ、より実践的な開発フローとなるようにプロンプトを再編成しました。

---

## NexSync開発ロードマップ＆プロンプト一覧 (スレッド機能対応版)

このロードマップは、リアルタイムチャットアプリ「NexSync」をゼロから完成させるまでの工程を示しています。各ステップのプロンプトをコピー＆ペーストして、AIとの対話を開始してください。

---

### フェーズ0: 準備＆設計

開発を始める前のウォーミングアップです。プロジェクトの全体像を固め、必要なツールを準備します。

#### **プロンプト 01: プロジェクトの初期設定と技術選定**
> **目的:** 開発の土台となるフォルダ構成を作成し、未定だった技術スタックを決定します。

```
添付された「NexSync要件定義書」（※スレッド機能を含む）に基づき、リアルタイムチャットアプリケーション「NexSync」の開発を開始します。

最初のステップとして、プロジェクトの全体的なフォルダ構成を提案してください。バックエンド（Node.js/Express）とフロントエンド（SPA）が共存するモノレポ形式を想定しています。

また、要件定義書で「適宜選定」となっている以下の技術について、それぞれのメリット・デメリットを比較し、今回のプロジェクトに最適なものを提案してください。

1.  **フロントエンドフレームワーク:** (例: React, Vue.js, Svelte)
2.  **UI/CSSフレームワーク:** (例: Tailwind CSS, Material-UI, Chakra UI)
```

---

### フェーズ1: バックエンド構築 (Node.js & Express)

サーバーサイドの基本的な機能を実装します。まずはAPIサーバーを立ち上げ、データベースと接続します。

#### **プロンプト 02: Expressサーバーの基本設定**
> **目的:** Webサーバーを起動し、APIのエンドポイントを作成する準備をします。

```
フェーズ0の提案に基づき、バックエンドの開発を進めます。
`backend` ディレクトリ内に、Node.jsとExpressを用いた基本的なWebサーバーを構築してください。
以下の要件を満たすコードを生成してください。

- `package.json` を初期化し、`express` と `dotenv`、`nodemon` をインストールする。
- `.env` ファイルからポート番号を読み込む。
- `/api` というルートパスを作成し、アクセスすると `{ "message": "Welcome to NexSync API" }` というJSONを返す。
- 開発中にコードの変更を自動で反映するため、`nodemon` を使った起動スクリプトを `package.json` に追加する。
```

#### **プロンプト 03: Supabaseとの接続設定とDB設計**
> **目的:** メインデータベースとなるSupabaseと接続し、スレッド機能を見越したテーブルを設計します。

```
次に、メインデータベースとなるSupabaseとの接続を設定します。
先ほど作成したExpressサーバーに、SupabaseのJavaScriptクライアント（`@supabase/supabase-js`）を導入してください。

- `.env` ファイルに `SUPABASE_URL` と `SUPABASE_ANON_KEY` を追加する。
- これらの環境変数を読み込んでSupabaseクライアントを初期化するモジュールを作成する。

そして、今後の開発で必要となる以下のテーブルを作成するためのSQLを提案してください。
- `channels` テーブル
- `messages` テーブル: **スレッド機能を実装するため、通常のカラムに加え、どのメッセージへの返信かを示す `parent_message_id` カラム（自分自身のテーブルの`id`を参照する、NULL許容の外部キー）を含めて設計してください。**
```

#### **プロンプト 04: Google APIのセットアップ**
> **目的:** GoogleスプレッドシートとGoogle Driveを操作するための認証情報を設定します。

```
NexSyncのコア機能であるGoogleスプレッドシートとGoogle Drive連携の準備をします。
Google Cloud Platformでサービスアカウントを作成し、JSONキーファイルを取得した前提で、Google Sheets APIとGoogle Drive APIをNode.jsから利用するための設定を行ってください。

- `googleapis` ライブラリをインストールする。
- サービスアカウントのJSONキーファイル（`credentials.json`など）を安全に読み込み、各API（Sheets, Drive）を認証・初期化するモジュールを作成する。
- `.env` に、操作対象のスプレッドシートIDを `GOOGLE_SHEET_ID` として追加する。
```

---

### フェーズ2: 認証機能の実装 (Googleスプレッドシート)

GoogleスプレッドシートをDBとしたユーザー認証機能を実装します。

#### **プロンプト 05: ユーザー登録機能**
> **目的:** 新規ユーザーがアカウントを作成できるようにします。セキュリティ要件も考慮します。

```
要件定義書に基づき、Googleスプレッドシートを利用したユーザー登録機能を実装します。
以下の仕様を満たす `/api/auth/register` エンドポイントをExpressで作成してください。

- **入力:** `email`, `password`, `adminKey`
- **処理:**
    1. `adminKey` が `.env` に設定された `REGISTRATION_ADMIN_KEY` と一致するか検証する。
    2. パスワードを `bcrypt` ライブラリでハッシュ化する。
    3. Google Sheets APIを使い、指定のスプレッドシート（例: "Users"シート）に `email` と `ハッシュ化されたパスワード` を新しい行として追記する。
    4. 既に同じ `email` が存在する場合はエラーを返す。
- **ライブラリ:** `bcrypt` をインストールして使用してください。
```

#### **プロンプト 06: ユーザーログインとセッション管理**
> **目的:** 登録済みユーザーがログインし、その状態を維持できるようにします。

```
次に、ユーザーログイン機能とセッション管理を実装します。
以下の仕様を満たす `/api/auth/login` エンドポイントを作成し、セッション管理の仕組みを導入してください。

- **ログインAPI (`/api/auth/login`):**
    - **入力:** `email`, `password`
    - **処理:**
        1. Googleスプレッドシートから `email` に一致するユーザー情報を検索する。
        2. ユーザーが見つかった場合、入力された `password` とスプレッドシートのハッシュ値を `bcrypt.compare` で比較する。
        3. 認証が成功したら、ユーザ情報をセッションに保存し、成功レスポンスを返す。
- **セッション管理:**
    - `express-session` などのライブラリを導入し、ログイン状態をサーバーサイドのセッションで管理する。
- **ログイン状態確認API (`/api/auth/me`):**
    - 現在のセッション情報からログイン中のユーザー情報を返すエンドポイントを作成する。
- **ログアウトAPI (`/api/auth/logout`):**
    - セッションを破棄するエンドポイントを作成する。
```

---

### フェーズ3: フロントエンド構築＆基本UI

ユーザーが実際に触る画面を作成していきます。

#### **プロンプト 07: フロントエンドプロジェクトのセットアップ**
> **目的:** プロンプト01で選定したフレームワークで、フロントエンドの雛形を作成します。

```
ここからフロントエンドの開発に移ります。
フェーズ0で選定したフロントエンドフレームワーク（例: React + Vite）とUIフレームワーク（例: Tailwind CSS）を使い、`frontend` ディレクトリに新しいプロジェクトを作成してください。

- バックエンドAPI (`http://localhost:[PORT]/api`) と通信するためのプロキシ設定を行う。
- `axios` などのHTTPクライアントライブラリを導入する。
- 画面遷移を管理するため、`react-router-dom` などのルーティングライブラリを導入する。
```

#### **プロンプト 08: 認証ページの作成**
> **目的:** ユーザーが操作する認証画面を作成し、バックエンドAPIと接続します。

```
バックエンドで作成した認証API（登録、ログイン）と連携するフロントエンドのページを作成します。

- **`/register` ページ:** メールアドレス、パスワード、管理者キーを入力し、登録APIを呼び出すフォームを作成する。
- **`/login` ページ:** メールアドレス、パスワードを入力し、ログインAPIを呼び出すフォームを作成する。
- ログイン成功後は、チャットページ（`/`）にリダイレクトする。
- 認証が必要なページに未ログインでアクセスした場合、ログインページにリダイレクトする「認証ガード」の仕組みを実装する。
```

#### **プロンプト 09: チャット画面の基本レイアウト作成**
> **目的:** NexSyncのメイン画面となるチャットUIの骨組みを作成します。スレッド表示用のエリアも確保します。

```
ログイン後のメイン画面となるチャットページの基本的なレイアウトを作成してください。
要件定義書を参考に、Slackのような3カラムレイアウトを想定します。

- **左カラム:** チャネル一覧、ユーザー情報表示エリア
- **中央カラム:** メッセージ表示エリア、メッセージ入力フォーム
- **右カラム:** **スレッド表示やファイル詳細などを表示するためのエリア。**普段は隠れており、特定の操作で表示されるようにする。

UIフレームワーク（例: Tailwind CSS）を活用して、スタイリッシュな骨組みを構築してください。
```

---

### フェーズ4: リアルタイムチャット機能の実装

アプリケーションの核となる、リアルタイムでのメッセージ送受信機能を実装します。

#### **プロンプト 10: WebSocket (Socket.io) の導入**
> **目的:** バックエンドとフロントエンドの両方にSocket.ioを導入し、リアルタイム通信の基盤を築きます。

```
リアルタイムチャット機能を実現するため、バックエンドとフロントエンドに `socket.io` を導入します。

- **バックエンド:**
    - `socket.io` をExpressサーバーに統合する。
    - クライアントが接続した際にログを出力する簡単な接続テストコードを実装する。
- **フロントエンド:**
    - `socket.io-client` をインストールする。
    - チャットページコンポーネントがマウントされた際に、バックエンドのSocket.ioサーバーに接続する処理を実装する。
```

#### **プロンプト 11: チャネル機能とメッセージ履歴表示**
> **目的:** 複数の会話スペース（チャネル）を作成・管理し、過去のメッセージを読み込めるようにします。

```
チャットをトピックごとに分離するためのチャネル機能と、メッセージ履歴表示を実装します。

- **バックエンド:**
    - チャネル一覧を取得するAPI (`/api/channels`) を作成する。
    - 新しいチャネルを作成するAPI (`/api/channels`) を作成する。
    - 特定チャネルのメッセージ履歴（**スレッドの親メッセージのみ**）を取得するAPI (`/api/messages/:channelId`) を作成する。無限スクロールを考慮し、ページネーションも実装する。
    - Socket.ioで、ユーザーが特定のチャネルのルームに参加・退出 (`joinChannel`, `leaveChannel`) できるようにする。
- **フロントエンド:**
    - 左カラムにチャネル一覧を表示し、クリックでチャネルを切り替えられるようにする。
    - チャネルを切り替えたら、メッセージ履歴APIを叩いて中央カラムに表示する。
```

#### **プロンプト 12: メッセージ送受信機能の実装 (メインチャット)**
> **目的:** ユーザーがメッセージを送信し、同じチャネルにいる他のユーザーがリアルタイムで受信できるようにします。

```
Socket.ioを使って、基本的なメッセージ送受信機能を実装します。ここではまだスレッドを考慮せず、メインのチャットのみを対象とします。

- **フロントエンド:**
    - メッセージ入力フォームからメッセージを送信した際、`'sendMessage'` イベントでメッセージ内容と `channelId` をサーバーに送信する。
    - サーバーから `'receiveMessage'` イベントを受信したら、画面上のメッセージリストに新しいメッセージを追加する。
- **バックエンド:**
    - クライアントから `'sendMessage'` イベントを受信したら、そのメッセージをSupabaseの `messages` テーブルに保存する（この時点では `parent_message_id` は `NULL`）。
    - 保存後、同じチャネルのルームに参加しているクライアントに `'receiveMessage'` イベントで新しいメッセージを送信する。
```

---

### フェーズ5: スレッド機能と応用機能の実装

チャットをより便利にするスレッド機能やファイル共有を実装します。

#### **プロンプト 13: スレッド機能の実装**
> **目的:** メッセージに対して返信スレッドを作成し、スレッド内で会話できるようにします。

```
今回の開発のコア機能である「スレッド機能」を実装します。バックエンドAPI、リアルタイム通信、フロントエンドUIを段階的に構築してください。

- **バックエンド:**
    1.  特定の親メッセージに紐づく返信一覧を取得するAPI (`/api/messages/:messageId/thread`) を作成する。
    2.  メッセージ送信処理を更新する。`'sendMessage'` イベントで `parent_message_id` を受け取れるようにする。
    3.  `parent_message_id` が指定されている場合、それはスレッドへの返信としてDBに保存する。
    4.  スレッドに新しい返信があったことを通知するためのSocket.ioイベント（例: `'newThreadMessage'`）を実装する。このイベントは、親メッセージIDと新しい返信メッセージのデータを送る。
- **フロントエンド:**
    1.  各メッセージに「スレッドで返信する」アイコンを追加する。メインチャットのメッセージにスレッド返信がある場合は、「N件の返信」のようなリンクを表示する。
    2.  これらのアイコン/リンクをクリックすると、右カラムにスレッドビューが表示されるようにする。
    3.  スレッドビューは、クリックされた親メッセージと、APIで取得した返信一覧、そしてスレッド内への返信フォームで構成する。
    4.  `'newThreadMessage'` イベントをリッスンし、開いているスレッドビューや、メインチャットの「N件の返信」表示をリアルタイムで更新する。
```

#### **プロンプト 14: ファイル共有機能 (Google Drive連携)**
> **目的:** Google Driveにファイルをアップロードし、そのリンクをチャットに共有できるようにします。

```
要件定義書にあるファイル共有機能を実装します。

- **バックエンド:**
    - ファイルアップロードリクエストを受け取り、Google Drive APIを使ってファイルを指定フォルダにアップロードし、共有リンクを生成して返すAPIを作成する。
- **フロントエンド:**
    - メッセージ入力フォーム（メインとスレッドの両方）にファイル選択ボタンを追加する。
    - ファイルを選択するとバックエンドAPIに送信し、返されたGoogle DriveのURLをメッセージとして送信する。
```

#### **プロンプト 15: 高度なチャット機能 (リアクション・メンション・編集・削除)**
> **目的:** Slackのような便利なコミュニケーション機能を追加します。

```
チャット体験を向上させるため、リアクション、メンション、編集、削除の各機能を実装します。それぞれの機能について、必要なAPIエンドポイント、DBスキーマの変更、フロントエンドのUIを提案してください。

1.  **リアクション:** メッセージに絵文字で反応できる機能。`reactions` テーブルが必要になります。
2.  **メンション:** `@username` や `@role` で特定の相手に通知できる機能。
3.  **メッセージ編集:** ユーザーが自分のメッセージを編集できる機能。
4.  **メッセージ削除:** 管理者のみがメッセージを削除できる機能。
```

---

### フェーズ6: 権限管理と管理機能

Googleスプレッドシートをマスターデータとして、柔軟な権限管理システムを構築します。

#### **プロンプト 16: ロールベースのアクセス制御 (RBAC)**
> **目的:** Googleスプレッドシートで定義したロールに基づき、機能へのアクセスを制御します。

```
Googleスプレッドシートを権限管理のマスターデータとして利用する、ロールベースアクセス制御（RBAC）を実装します。

- **Googleスプレッドシートの準備:**
    - 「Roles」シート: `user_email`, `role`（例: admin, moderator, user）
    - 「ChannelAccess」シート: `channel_id`, `role` or `user_email`
- **バックエンド:**
    - ユーザーのロールや権限を確認する関数をGoogle Sheets APIを使って作成し、ExpressのミドルウェアとしてAPIリクエストを保護する仕組みを実装する。
- **フロントエンド:**
    - ユーザーのロールに応じて、UIの表示を切り替える（例: 管理者のみ削除ボタンを表示）。
```

#### **プロンプト 17: 管理者用ダッシュボード**
> **目的:** 管理者がフロントエンドから直接ユーザーのロールやチャネル設定を変更できるようにします。

```
管理者権限を持つユーザー向けに、アプリケーションの設定を変更できる管理画面を作成します。

- **UI:** `/admin` などの専用ページを作成する。
- **機能:**
    1. ユーザー一覧を表示し、ロールを変更できる機能。
    2. チャネルの作成・削除ができる機能。
    3. 各チャネルのアクセス権を編集できる機能。
- **バックエンド:**
    - 上記の操作を行うためのAPIエンドポイント群を作成し、RBACミドルウェアで厳密に保護する。
    - APIは、受け取った変更内容をGoogle Sheets APIを介してスプレッドシートに反映させる。
```

---

### フェーズ7: 仕上げと運用準備

アプリケーションを公開し、安定して運用するための準備をします。

#### **プロンプト 18: UX/UIの改善**
> **目的:** ユーザー体験を向上させるための最終調整を行います。

```
アプリケーションの使い心地を向上させるための改善を行います。以下の機能を実装してください。

1.  **レスポンシブデザイン:** スマートフォンやタブレットでもレイアウトが崩れないようにスタイルを調整する。
2.  **ダークモード/ライトモード:** ユーザーがテーマを切り替えられる機能を実装する。
3.  **その他:** ローディング中のスピナー表示、エラーメッセージのトースト通知など、細かいUI/UXの改善点を提案・実装してください。
```

#### **プロンプト 19: デプロイ準備と実行**
> **目的:** アプリケーションをインターネットに公開します。

```
開発したNexSyncアプリケーションを、要件定義書に従ってRender.comにデプロイします。
バックエンドとフロントエンドをそれぞれデプロイするための手順を、Render.comの仕様に合わせて説明してください。（`render.yaml` の作成、環境変数の設定など）
```

#### **プロンプト 20: バックアップとアーカイブ戦略の実装**
> **目的:** データの安全性を確保し、古いメッセージを閲覧する仕組みを構築します。

```
要件定義書にあるデータベースのバックアップとアーカイブ閲覧機能について、実現可能な方法を実装します。

- **自動バックアップ:**
    - GitHub Actionsを使用して、毎日定時にSupabaseのデータをダンプし、GitHubプライベートリポジトリに保存するワークフローを作成する。
- **アーカイブ閲覧機能:**
    - **【重要】** 要件定義書ではこの機能の難易度が高いと指摘されています。まずは実現可能性の高いシンプルな方法（例: 管理者向けにSQLファイルをダウンロード/検索するローカルツールや手順の提示）を提案してください。
```

#### **プロンプト 21: READMEの作成**
> **目的:** プロジェクトの概要やセットアップ方法をまとめたドキュメントを作成します。

```
最後に、このNexSyncプロジェクトの `README.md` ファイルを作成してください。
アプリケーションの概要、技術スタック、ローカルでのセットアップ手順、デプロイ、Google APIやSupabaseの設定に関する注意事項などを網羅した、分かりやすいドキュメントをお願いします。
```