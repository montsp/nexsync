NexSync要件定義書   
1. はじめに
このドキュメントは、リアルタイムチャットアプリケーション「NexSync」（Slackクローン簡易版）の主要な機能、技術スタック、および非機能要件を定義します。本アプリケーションは、既存のSaaSチャットツールの機能に制約を感じている組織向けに、半年間の短期利用を想定したカスタマイズ可能なチャットソリューションとして開発されます。

2. アプリケーションの概要
本アプリケーションは、ウェブブラウザ上で動作するシングルページアプリケーション（SPA）形式のリアルタイムチャットツールです。ユーザーは特定のチャネルに参加し、テキストメッセージの送受信、およびファイルの共有（Google Drive連携）が可能です。ユーザー認証、ロール管理、およびチャネルアクセス権限はGoogleスプレッドシートAPIを用いて管理されます。

3. 機能要件
3.1. ユーザー管理
ユーザー登録: ユーザーはメールアドレスとパスワードでアカウントを作成できる。作成されたアカウント情報（メールアドレス、パスワードのハッシュ値）はGoogleスプレッドシートに保存される。セキュリティ上の都合により、アカウント作成時には、環境変数に設定された管理者のみが知る特定のキー（パスワードなど）の入力が必要となる。

ログイン/ログアウト: 登録済みユーザーはGoogleスプレッドシートに保存された情報に基づいてログイン/ログアウトできる。

セッション管理: ログイン状態を保持できる。

ユーザー情報表示: ログインユーザーのユーザー名を表示できる。

3.2. チャット機能
チャネル一覧表示: 参加可能なチャネルの一覧を表示できる。

チャネル作成: ユーザーは新しいチャネルを作成できる。

チャネル参加/退出: ユーザーは任意のチャネルに参加・退出できる。

メッセージ送信:

選択中のチャネルにテキストメッセージを送信できる。

1メッセージあたり平均500文字程度まで対応できる。

メッセージ受信:

リアルタイムで新しいメッセージを受信し、チャット画面に表示できる。

自分が送信したメッセージもリアルタイムで画面に反映される。

メッセージ履歴表示:

チャネルに参加した際に、過去のメッセージ履歴を読み込み表示できる。

履歴は直近のものが表示され、スクロールによりさらに過去のメッセージを読み込める。

備考: メインデータベースの容量制限のため、一定期間（例: 3ヶ月）より古いメッセージはメインデータベースから削除される。これらのアーカイブされたメッセージは、別途提供される履歴閲覧機能を通じてアプリケーションから閲覧できる。

リアクション・メンション: メッセージに対してリアクション（例: いいね、悲しい、驚きなど）を付与できる。@を用いた、ロールやユーザー名へのメンションも可能。また、メッセージの編集や削除機能（削除は管理者のみ可能）も実装する。

スレッド機能: メッセージに対してスレッドを作成できる。スレッドはネスト可能で、メッセージの編集や削除、リアクションの付与などの機能も提供する。


3.3. ファイル共有機能
ファイルアップロード:

ユーザーはメッセージにファイルを添付して送信できる。

ファイルはGoogle Driveに保存される。

ファイルアップロード後、チャットにはGoogle DriveのファイルURLが表示され、クリックでアクセスできる。

ファイルダウンロード/閲覧: チャットに表示されたURLをクリックすることで、共有されたファイルを開き、閲覧またはダウンロードできる。

3.4. ロールとアクセス権管理 (Googleスプレッドシートベース)
ロール管理: ユーザーには複数のロール（例: 「管理者」「モデレーター」「一般ユーザー」など）を割り当てられる。ロール情報はGoogleスプレッドシートで管理され、ユーザーごとに複数のロールを紐付けることができる。

チャネルアクセス権: 各チャネルへのアクセス権（閲覧、メッセージ送信など）は、ユーザーのロールまたは個別のユーザーIDに基づいて管理される。このアクセス権定義もGoogleスプレッドシートで管理される。

権限付与/剥奪: 管理者はGoogleスプレッドシートを直接編集することで、ユーザーのロール変更やチャネルへのアクセス権の付与/剥奪を行える。

3.5. 管理機能 (フロントエンドからの設定変更)
設定管理: 管理者権限を持つアカウントは、フロントエンドの管理画面から、アプリケーションの主要な設定（例: ユーザーのロール変更、チャネルの作成/削除、チャネルへのアクセス権の調整など）を操作できる。これらの変更はGoogleスプレッドシートに反映される。

4. 非機能要件
4.1. パフォーマンス
リアルタイム性: メッセージ送信から他のユーザーへの表示までがスムーズに行われる（数秒以内）。

メッセージ処理能力: 1日平均500メッセージの送受信を安定して処理できる。

UI応答性: アプリケーションのUI操作がスムーズで、遅延を感じさせない。

Googleスプレッドシート連携の考慮: 認証時やロール/権限確認時にGoogleスプレッドシートAPIへのアクセスが発生するため、その際のパフォーマンス遅延が発生する可能性がある。特に同時アクセスが多い場合や、スプレッドシートのデータ量が多い場合は注意が必要。

アーカイブ履歴表示のパフォーマンス: アーカイブされたメッセージ履歴の読み込みと表示は、メインデータベースからの取得と比較して、パフォーマンスに大きな影響を与える可能性がある。特に、大量のアーカイブデータに対する高速な検索や表示には課題が伴う。

4.2. データ永続化・信頼性
データベース: すべてのチャットメッセージ、ユーザー情報、チャネル情報はデータベースに永続的に保存される。

データ容量: 半年間で、1日平均500メッセージ（500文字/メッセージ）のテキストデータがSupabaseの500MB無料枠に収まることを目標とする。

ファイル永続化: アップロードされたファイルはGoogle Driveに永続的に保存される。

Googleスプレッドシートの信頼性: 認証・権限データはGoogleスプレッドシートに依存するため、スプレッドシート自体の可用性、APIのレート制限、および手動による誤編集のリスクを考慮する必要がある。

アーカイブデータの信頼性: GitHubリポジトリに保存されたSQLダンプから履歴を閲覧するシステムは、データ構造の変更やデータ量増加により複雑性が増し、その信頼性と運用負荷に注意が必要。

4.3. セキュリティ
ユーザー認証:

ユーザーパスワードは平文ではなく、ハッシュ化された値としてGoogleスプレッドシートに保存される。

認証フローはNode.jsバックエンドで実装され、GoogleスプレッドシートAPIを通じてハッシュ値の比較を行う。

重要: Googleスプレッドシートを認証情報ストアとして使用することは、専用の認証サービス（例: Supabase Auth、Firebase Authなど）と比較して、セキュリティ面でのリスク（例: APIキーの管理、不正アクセス対策、詳細な監査ログ、レート制限、パスワードリセットフローの複雑性など）が高まるため、慎重な設計と実装が必要である。

データ転送: クライアントとサーバー間の通信は暗号化される（HTTPS/WSS）。

Google Driveアクセス: Google Drive APIへのアクセスはOAuth 2.0などの安全な認証方式で行う。

権限管理: ロールやチャネルアクセス権はGoogleスプレッドシートで管理されるが、アプリケーション側でGoogleスプレッドシートAPIへのアクセス権限を最小限に制限し、バックエンドでの厳密な検証を行う必要がある。

4.4. 運用・保守
デプロイ: 簡単かつ迅速にアプリケーションをデプロイできる。

バックアップ:

Supabaseデータベースのデータは定期的に（例: 毎日）バックアップされる。このバックアップ処理はGitHub Actionsを用いて自動化される。

バックアップファイルはGitHubプライベートリポジトリにSQLダンプ形式で保存される。

アーカイブ履歴閲覧: メインデータベースから削除された古いメッセージ履歴は、バックアップされたデータからアプリケーション経由で閲覧できる。これを実現するためには、バックエンドがアーカイブされたデータを読み込み、効率的にフロントエンドに提供する仕組みが必要となる。この機能の実装は、提案された技術スタック（無料枠でのGitHubリポジトリへのSQLダンプ保存）では非常に高い技術的困難性とパフォーマンス課題を伴うため、慎重な設計とリソースの検討が必要となる。

監視: データ使用量などの基本的な監視はSupabaseのダッシュボードで確認できる。GoogleスプレッドシートAPIの呼び出し状況やエラーも監視する必要がある。

4.5. ユーザーエクスペリエンス (User Experience)
直感的な操作性: ユーザーが特別な学習なしに、チャットの送受信、チャネルの切り替え、ファイル添付などの主要な操作を直感的に行えるUIとする。

明確な情報表示: メッセージの送信者、時刻、チャネル名などが分かりやすく表示される。

視認性: 適切なフォントサイズ、コントラスト、レイアウトにより、長時間の利用でも目の疲れにくいデザインとする。

レスポンシブデザイン: 様々なデバイス（デスクトップ、モバイル）や画面サイズに対応し、レイアウトが崩れずに利用できること。

ダークモード/ライトモード対応: ユーザーが好みに応じて、アプリケーションの表示テーマをダークモードとライトモードで切り替えられる機能を提供する。

5. 技術スタック
5.1. フロントエンド
フレームワーク: SPA(適宜選定)

UI/CSS: 適宜選定

リアルタイム通信: socket.io-client

Google Drive連携: Google Drive API (JavaScript SDK)

5.2. バックエンド
言語/フレームワーク: Node.js + Express

リアルタイム通信: socket.io

データベース連携: Supabase JavaScript SDK (または類似のPostgreSQLクライアント)

認証・権限管理: Google Sheets API (Node.js Client) およびパスワードハッシュ化ライブラリ (bcryptなど)

ファイル連携: Google Drive API (Node.js Client, 必要に応じて)

5.3. データベース
サービス: Supabase (PostgreSQLベース)

役割: チャットメッセージ、チャネル情報のメインデータストアとして利用。

5.4. ファイルストレージ
サービス: Google Drive

5.5. デプロイ
バックエンド: Render.com (Web Service)

フロントエンド: Render.com (Static Site) または Vercel / Netlify / GitHub Pages

5.6. バックアップ
データベースバックアップツール: Supabase CLI

自動化/保存先: GitHub Actions を利用して定期的にバックアップを実行し、その結果をGitHub Private Repositoryに保存する。

5.7. 認証・権限管理データストア
サービス: Googleスプレッドシート

役割: ユーザーのログイン認証情報（ハッシュ化されたパスワード）、ユーザーロール、チャネルアクセス権限の定義を保存。